# 트랜잭션 범위의 영속성 컨텍스트

- 스프링 컨테이너의 기본 전략

<br>

## 스프링 컨테이너의 기본 전략

> 스프링 컨테이너는 **트랜잭션 범위의 영속성 컨텍스트** 전략을 기본으로 사용한다.

- 트랜잭션의 범위와 영속성 컨텍스트의 생존 범위가 같다.

- 트랜잭션을 시작할 때 영속성 컨텍스트를 생성하고, 트랜잭션이 끝날 때 영속성 컨텍스트를 종료한다.

- 같은 트랜잭션 안에서는 항상 같은 영속성 컨텍스트에 접근한다.

> @Transactional 어노테이션

- 이 어노테이션이 있으면 호출한 메소드를 실행하기 직전에 `스프링의 트랜잭션 AOP`가 먼저 동작한다.

- `스프링 트랜잭션 AOP`는 대상 메소드를 호출하기 직전에 트랜잭션을 시작하고, 대상 메소드가 정상 종료되면 트랜잭션을 커밋하면서 종료한다.

- 트랜잭션을 커밋하면 JPA는 먼저 영속성 컨텍스트를 플러시해서 변경 내용을 데이터베이스에 반영한 후에 데이터베이스 트랜잭션을 커밋한다.

> 트랜잭션이 같으면, 같은 영속성 컨텍스트를 사용한다.

- 트랜잭션 범위의 영속성 컨텍스트 전략은 다양한 위치에서 엔티티 매니저를 주입받아 사용해도 트랜잭션이 같으면, 항상 같은 영속성 컨텍스트를 사용한다.

- 엔티티 매니저는 달라도 같은 영속성 컨텍스트를 사용한다.

> 트랜잭션이 다르면, 다른 영속성 컨텍스트를 사용한다.

- 여러 스레드에서 동시에 요청이 와서 **같은 엔티티 매니저를 사용해도 트랜잭션에 따라 접근하는 영속성 컨텍스트가 다르다.**

- 스프링 컨테이너는 스레드마다 각각 다른 트랜잭션을 할당한다.

- 같은 엔티티 매니저를 호출해도 접근하는 영속성 컨텍스트가 다르므로 멀티스레드 상황에서 안전하다.

> 스프링이나 J2EE 컨테이너의 가장 큰 장점

- 트랜잭션과 복잡한 멀티 스레드 상황을 스프링 컨테이너가 처리해준다.

- 개발자는 싱글 스레드 애플리케이션처럼 단순하게 개발할 수 있으며, 비즈니스 로직 개발에 집중할 수 있다.

> 스레드, 트랜잭션, 영속성 컨텍스트

- `스레드 == 트랜잭션 == 영속성 컨텍스트` 범위내에서는 `id(pk)` 값만 같아도 같은 엔티티 객체로 본다.
- 영속성 컨텍스트는 `REPEATABLE READ` 로 동작한다.
