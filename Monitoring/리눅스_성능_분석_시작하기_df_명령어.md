# 리눅스 성능 분석 시작하기 - df 명령어

## df

```shell
$ df -h
```

|     Filesystem     | Size  |  Used   |    Avail    | Use% | Mounted on |
|:------------------:|:-----:|:-------:|:-----------:|:----:|:----------:|
| 파일 시스템이 상주하는 장치 이름 | 전체 크기 | 사용중인 크기 | 사용할 수 있는 크기 | 사용률  |   마운트 위치   |

- `df -h` 명령을 입력하면, 파티션을 확인할 수 있다.
    - `-h` : `human readable(사람이 읽기 좋은)`
- 디스크의 여유 공간과 inode 공간 확인을 위해 사용되는 명령어이다.

## 파일 시스템이 100%가 된다면?

- Root 파티션이 꽉 차게 되면, `No space left on device` 에러가 발생한다.
    - 디스크 Full 되었다.
- 어떠한 명령어도 제대로 동작하지 않게 된다.
- Root 파티션의 문제가 생겼을때, 최악의 경우에는 SSH 접속도 불가능하다.

## 디렉토리 별 사용량 측정

- `du` 명령어로 어떤 디렉토리 별로 사용 정보를 확인할 수 있다.
- `du -sh ./*` 명령
    - Root 디렉토리에서 하단 디렉토리를 모두 볼 수 있다. (`./bin`, `./data`, `./dev`, `./etc`, `./home`, `./lib`, `./local`, `./usr`)

## 파일을 지웠는데 용량이 늘어나지 않는 경우

- `8GB` 가 꽉 차있는 상태에서 `2GB` 파일을 지웠지만, `df` 로 확인해도 사용량은 그대로인 경우가 있다.
    - `Used` 영역이 `8GB` 가 아닌 `6GB` 가 되어야 한다.
- 위의 경우를 이해하기 위해서는 `파일 핸들` 을 이해해야 한다.

## 파일 핸들

- 어떤 프로세스가 파일을 읽을때, `파일 핸들` 에 파일 참조하고 있다는 것을 기록한다.
- 그런데 파일 핸들에 `파일 참조가 지워지지 않으면`, `파일을 지워도 지워지지 않고 용량이 늘어나지 않는다.`
- `lsof` 명령어로 파일 핸들을 확인하고 프로세스를 종료시키면, 파일 핸들이 반환되고 실제로 파일이 지워진다.
    - `Used` 영역이 `6GB` 로 된다.

## inode 사용률

- `inode` 는 파일,디렉토리에 대한 메타데이터를 저장하는 구조체이다.
- 쉽게 설명하자면, `파일과 디렉토리의 개수` 를 의미한다.
    - 파일이 10개면, `inode` 도 10개가 생긴다.
- `df -i` 명령으로 파일과 디렉토리의 개수를 확인할 수 있다.

|     Filesystem     |       Inodes       |    IUsed     |      IFree       |   IUse%   | Mounted on |
|:------------------:|:------------------:|:------------:|:----------------:|:---------:|:----------:|
| 파일 시스템이 상주하는 장치 이름 | 사용할 수 있는 inode 최대값 | 사용중인 inode 값 | 사용할 수 있는 inode 값 | inode 사용률 |   마운트 위치   |

## 정리

- `df` 명령을 이용해서 `디스크 여유 공간` 및 `inode 공간` 을 확인할 수 있다.
- 간혹 `파일 핸들` 이 남아 있어서 파일을 지웠지만, 지워지지 않는 경우가 있다.
    - `lsof` 명령을 통해 `파일 핸들` 을 확인하고, 점유하고 있는 프로세스를 종료시킨다.
- `inode` 는 `파일과 디렉토리의 개수` 로 생각하면 된다.
    - `inode` 에도 최대값이 있으며, 그 이상 파일을 만들 수 없다.

## 참고

- [인프런 - 리눅스 성능 분석 시작하기](https://www.inflearn.com/course/%EB%A6%AC%EB%88%85%EC%8A%A4-%EC%84%B1%EB%8A%A5-%EB%B6%84%EC%84%9D-%EC%8B%9C%EC%9E%91%ED%95%98%EA%B8%B0/dashboard)

