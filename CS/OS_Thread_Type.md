# 스레드 종류

## 컴퓨터 시스템 구성도

<img width="777" alt="스크린샷 2023-06-14 오후 10 06 58" src="https://github.com/bestdevhyo1225/dev-log/assets/23515771/c32ff550-3774-43b4-987f-7111f58a8718">

- 총 3개의 레이어로 구성되어 있다.
    - `유저 프로그램`, `OS 커널`, `하드웨어(메모리, CPU, Devices)`

## 하드웨어 스레드

### 코어(Core)의 고민

- 메모리에서 데이터를 기다리는 시간이 꽤 오래 걸린다.

### 메모리를 기다리는 동안 다른 스레드를 실행하는 건 어떨까?

<img width="777" alt="스크린샷 2023-06-14 오후 10 18 59" src="https://github.com/bestdevhyo1225/dev-log/assets/23515771/243b34c1-bc01-418b-8217-7854d7f85538">

- `Compute` 작업을 하는 경우에는 `코어` 가 열심히 일한다.
- `Memory` 에 접근하는 동안에 `코어` 는 아무일도 하지 않는다.
- `Memory` 를 접근할 때마다 `코어` 를 쉬게되면, `코어` 를 낭비하게 된다.
- `Memory` 에 접근하는 동안에 독립적으로 또 다른 `Compute` 를 실행하는 아이디어를 생각하게 되었다.
- `코어` 는 1개인데, `코어` 의 사용률을 극대화 시키기 위해서 2개의 서로 다른 스레드를 실행시킨다.
- 각각의 스레드를 **`하드웨어 스레드`** 라고 한다.

### 인텔의 Hyper Threading

- 물리적인 `코어` 마다 하드웨어 스레드가 2개씩 둔다.

### 그래서 하드웨어 스레드란?

- OS 관점에서는 `가상(Logical)` 의 코어이다.
- 만약에 `싱글 코어 CPU` 에서 `하드웨어 스레드` 가 2개라면, OS는 해당 CPU를 `듀얼 코어` 로 인식한다.
- `듀얼 코어` 에 맞춰서 OS 레벨의 스레드들을 스케줄링한다.

### 퀴즈

- 인텔 `듀얼 코어 CPU` 에 Hyper Threading이 적용됐다면, 하드웨어 스레드는 총 몇 개일까?
    - 코어는 2개
    - 코어마다 각각 하드웨어 스레드가 2개씩 존재
    - 하드웨어 스레드는 총 4개이다.

## OS 스레드

### 커널

- 운영체제의 핵심
- 시스템의 전반을 관리/감독하는 역할을 한다.
- 하드웨어와 관련된 작업을 직접 수행한다.

### OS 스레드는 무엇인가?

- `OS 커널` 레벨에서 생성되고, 관리되는 스레드이다.
- 우리가 일반적으로 배웠고, 알고 있는 스레드 개념이다.

### OS 스레드에서 중요한 부분

- CPU에서 실제 실행되는 단위
- CPU 스케줄링 단위
- OS 스레드의 컨텍스트 스위칭은 `커널` 이 개입한다. (`비용 발생`)
- 컨텍스트 스위칭이 일어날 때마다 `유저 모드` 에서 `커널 모드` 로 전환이 되고, 여러 `커널 코드` 가 CPU에서 실행하게 되고, 다시 컨텍스트 스위칭이 끝나게 되면 `커널 모드` 에서 `유저 모드` 로
  전환되는 과정이기 때문에 비용이 발생한다.
- 개발자가 작성한 `사용자 코드` 와 `커널 코드` 들은 모두 OS 스레드에서 실행된다.

### OS 스레드는 아래와 같이 불리기도 함

- `네이티브(Native) 스레드`
- `커널 스레드*`
- `커널 레벨 스레드`
- `OS 레벨 스레드`

### 퀴즈

- OS 스레드 8개가 Hyper Threading이 적용된 인텔 듀얼코어 위에서 동작한다면, OS 스레드들을 어떻게 코어에 균등하게 할당할 수 있을까?
    - `물리적인 코어` 는 `2개` 이다.
    - Hyper Threading에 의해서 물리적인 코어의 `하드웨어 스레드` 는 `2개` 이다.
    - 따라서 OS가 바라보는 하드웨어 스레드는 `4개` 이다.
    - `4개` 의 하드웨어 스레드에 OS 스레드들을 균등하게 배분하려면, 하드웨어 스레드 당 `2개` 씩 할당하면 된다.

## 유저 스레드

### 유저 스레드는 무엇인가?

- `유저 프로그램` 영역에 해당되는 부분이다.
- `유저 레벨 스레드` 라고 불리기도 한다.
- 스레드 개념을 프로그래밍 레벨에서 추상화 한 것이다.

### Java 예시

```java
public class Main {
    public static void main(String args[]) {
        Thread thread = new Thread();
        thread.start();
    }
}
```

- `Thread` 는 `유저 스레드` 라고 이해할 수 있다.
- `유저 스레드` 가 CPU에서 실행되려면, `OS 스레드` 와 반드시 연결되어야 한다.

### 유저 스레드와 OS 스레드를 어떻게 연결시킬 것인가?

#### One-to-One Model

- `유저 스레드` 와 `OS 스레드` 가 `1:1` 로 연결이 되는 모델이다.
- 스레드 관리를 OS에 위임하게 된다. (스케줄링 포함)
- 스케줄링도 포함하기 때문에 커널이 스케줄링도 수행한다.
- 멀티코어도 잘 활용한다.
- 하나의 스레드가 `Block` 상태가 되도 다른 스레드는 영향을 받지 않고, 정상적으로 동작한다.
- OS 스레드들과 1:1 관계이기 때문에 어떻게 실행되는지에 따라서 `race condition` 이 발생할 수도 있다.

## 그린 스레드

## 참고

- [스레드 종류 설명 영상 보기](https://www.youtube.com/watch?v=vorIqiLM7jc&list=PLcXyemr8ZeoQOtSUjwaer0VMJSMfa-9G-&index=11) 

