# 인터럽트(Interrupt)와 시스템 콜(System Call)

## 유저 모드 & 커널 모드

- 우리가 개발하는 프로그램을 일반적으로 `유저 모드` 에서 실행된다.
- 프로그램 실행 중에 `인터럽트(Interrupt)` 가 발생하거나, `시스템 콜(System Call)` 을 호출하게 되면, `커널 모드` 로 전환한다.
- `커널 모드` 에서는 프로그램의 현재 CPU 상태를 저장한다.
- `커널` 이 `시스템 콜(System Call)`, `인터럽트(Interrupt)` 를 직접 처리한다. 즉, CPU에서 커널 코드가 실행된다.
- 처리가 완료되면, 중단됐던 프로그램의 CPU 상태를 복원한다.
- 다시 통제권을 프로그램에게 반환하고, `커널 모드` 에서 `유저 모드` 로 전환한다.
- `유저 모드` 에서는 프로그램이 이어서 실행된다.

## 커널

- 운영체제의 핵심이다.
- 시스템의 전반을 관리/감독하는 역할을 담당한다.
- 하드웨어와 관련된 작업을 직접 수행한다.

## 커널 모드를 만든 이유?

- 시스템을 보호하기 위해서 `커널 모드` 를 만들었다. (특히 하드웨어 부분)

## 인터럽트 (Interrupt)

- 시스템에서 발생한 다양한 종류의 이벤트 혹은 그런 이벤트를 알리는 메커니즘이다.

## 인터럽트 종류

- 전원(Power)에 문제가 생겼을 때
- I/O 작업이 완료됐을 때
- 시간이 다 됐을 때 (Timer 관련)
- 0으로 나눴을 때
- 잘못된 메모리 공간에 접근을 시도할 때

## 인터럽트가 발생하면?

- CPU에서는 즉각적으로 인터럽트 처리를 위해 `커널 코드` 를 `커널 모드` 에서 실행한다.

## 시스템 콜 (System Call)

- 프로그램이 OS 커널이 제공하는 서비스를 사용하고 싶을 때, `시스템 콜(System Call)` 을 통해서 실행한다.

## 시스템 콜의 종류

- 프로세스/스레드 관련
    - 프로세스/스레드를 새로 생성한다던지?
    - 반대로 프로세스/스레드를 Kill 한다던지?
- 파일 I/O 관련
    - 파일 읽기/쓰기
- 소켓 관련
    - 네트워크 관련 작업
- 장치(Device) 관련
    - 키보드에서 입력을 받음
- 프로세스 통신 관련

## 시스템 콜이 발생하면?

- 해당 `커널 코드` 가 `커널 모드` 에서 실행된다.
    - 시스템 콜에 대응하는 각각의 `커널 코드` 가 있다.

## 시스템 콜 & 인터럽트 예제 - 파일 read

<img width="1569" alt="스크린샷 2023-06-13 오후 10 11 19" src="https://github.com/bestdevhyo1225/dev-log/assets/23515771/4b11bbc6-802c-4116-97a2-d1352eea1b87">

- `t1` 이 `시스템 콜(read)` 을 하면, 유저 모드에서 `커널 모드` 로 전환된다.
- `커널 모드` 에서는 `t1` 의 cpu 상태를 저장하고, 파일을 읽을 준비한다.
- `t1` 은 `WAITING` 상태가 되며, `t2` 는 `RUNNING` 상태가 된다.
- 커널 모드에서 `유저 모드` 로 전환되며, `t2` 가 계속해서 실행된다.
- `인터럽트` 를 통해 파일 읽을 준비가 완료 됐다고 알려주고, `인터럽트` 를 처리하기 위해서 다시 `커널 모드` 로 전환된다.
- `t2` 의 cpu 상태를 저장하고, `t1` 은 파일을 읽을 준비가 됐기 때문에 `READY` 상태가 된다.
- `t2` 의 cpu 상태를 복원하고, 다시 `유저 모드` 로 전환된다.
- `t2` 는 중단됐던 부분부터 이어서 시작한다.
- `t2` 는 자기에게 주어진 `time slice` 를 다 사용했다. 이 때, `Timer` 라는 하드웨어에서 `인터럽트` 발생시켜, 시간을 다 썼다는 것을 알려주기 위해 `커널 모드` 로 전환한다.
- `t2` 의 cpu 상태를 저장하고 `READY` 상태가 되며, `t1` 은 `RUNNING` 상태가 되고 cpu 상태가 복원된다. 그리고 `유저 모드` 로 전환한다.
- `t1` 은 `유저 모드` 에서 파일의 데이터를 읽어오는 작업을 이어서 시작한다.

## 프로그래밍 언어와 시스템 콜

- 하드웨어 혹은 `시스템 콜(System Call)` 관련 기능은 어떤 프로그램이라도 반드시 시스템 콜을 통해서만 사용이 가능하다.
- 우리가 사용하는 프로그래밍 언어들이 `시스템 콜(System Call)` 을 `포장(Wrapping)` 하여 간접적으로 사용할 수 있도록 제공한다.

## java.lang.Thread class

```java
Thread thread = new Thread();
thread.start();
```

```java
public synchronized void start() {
    boolean started = false;
    try {
        start0();
        started = true;
    } finally {
        // 생략...    
    }
}

private native void start0();
```

- `native` 키워드가 붙으면, 보통 운영체제를 말한다.
- `JNI(Java Native Interface)` 를 통해서 OS의 시스템 콜을 할 수 있다.
- `start0()` 메소드는 `clone` 이라는 시스템 콜을 호출한다.

## 참고

- [인터럽트(Interrupt)와 시스템 콜(System Call) 설명 영상 보기](https://www.youtube.com/watch?v=v30ilCpITnY&list=PLcXyemr8ZeoQOtSUjwaer0VMJSMfa-9G-&index=10)
